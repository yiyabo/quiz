# 🎯 多竞赛功能说明

## ✅ 已完成的功能

### 后端 (Backend)

1. **数据库模型更新**
   - ✅ 添加 `Competition` 表（竞赛表）
   - ✅ `Submission` 表关联到 `competition_id`
   - ✅ 自动初始化两个竞赛数据

2. **竞赛数据**
   - ✅ PPI竞赛（蛋白质相互作用预测）
   - ✅ CCI竞赛（细胞间相互作用预测）

3. **API接口**
   - ✅ `GET /api/competitions` - 获取竞赛列表
   - ✅ `GET /api/competitions/{id}` - 获取竞赛详情
   - ✅ `POST /api/submissions?competition_id=X` - 提交时指定竞赛
   - ✅ `GET /api/leaderboard?competition_id=X` - 按竞赛筛选排行榜
   - ✅ `GET /api/download/dataset/{competition_id}` - 下载竞赛数据集

4. **评分系统**
   - ✅ `scoring.py` - PPI竞赛评分（protein_A, protein_B, prediction）
   - ✅ `scoring_cci.py` - CCI竞赛评分（source, target, label）
   - ✅ 两个竞赛使用相同的加权评分标准

### 前端 (Frontend)

1. **API接口适配**
   - ✅ 添加 `competitionAPI` - 竞赛接口
   - ✅ 更新 `submissionAPI` - 支持竞赛ID参数
   - ✅ 更新 `leaderboardAPI` - 支持竞赛筛选
   - ✅ 更新 `downloadAPI` - 支持竞赛ID

2. **状态管理**
   - ✅ 创建 `stores/competition.js` - 竞赛状态管理
   - ✅ 竞赛选择和切换功能

---

## 🚀 如何使用

### 启动系统

1. **启动后端**（会自动初始化两个竞赛）
   ```bash
   cd /Users/apple/work/quiz/backend
   conda activate quiz
   python main.py
   ```
   
   看到以下信息表示成功：
   ```
   ✅ 数据库初始化完成
   ✅ 竞赛数据初始化完成
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ```

2. **测试API**（可选）
   ```bash
   # 获取竞赛列表
   curl http://localhost:8000/api/competitions
   
   # 应该返回两个竞赛：
   # [
   #   {"id":1,"name":"ppi","title":"蛋白质相互作用预测",...},
   #   {"id":2,"name":"cci","title":"细胞间相互作用预测",...}
   # ]
   ```

3. **启动前端**（在新终端）
   ```bash
   cd /Users/apple/work/quiz/frontend
   npm run dev
   ```

---

## 📊 两个竞赛的区别

### 1. PPI竞赛（蛋白质相互作用预测）

**数据集**: `kaggle_dataset.tar.gz`

**提交格式**:
```csv
protein_A,protein_B,prediction
9606.ENSP00000178640,9606.ENSP00000256458,1
9606.ENSP00000253727,9606.ENSP00000257724,0
```

**答案文件**: `teacher_only/test_labels.csv`

**测试集**: 1,525 个样本

---

### 2. CCI竞赛（细胞间相互作用预测）

**数据集**: `cci test/dataset.tar.gz`（包含.h5ad文件）

**提交格式**:
```csv
source,target,label
1999,2313,1
4252,1273,0
```

**答案文件**: `cci test/answer/test_edges.csv`

**测试集**: 4,000 个样本

---

## 🧪 测试步骤

### 方法1: 使用API直接测试

```bash
# 1. 注册用户
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"123456"}'

# 2. 获取token（从返回的JSON中复制access_token）
TOKEN="your_token_here"

# 3. 下载PPI数据集
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/download/dataset/1 \
  -o ppi_dataset.tar.gz

# 4. 下载CCI数据集
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/download/dataset/2 \
  -o cci_dataset.tar.gz

# 5. 提交到PPI竞赛
curl -X POST "http://localhost:8000/api/submissions?competition_id=1" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@path/to/your/submission.csv"

# 6. 提交到CCI竞赛
curl -X POST "http://localhost:8000/api/submissions?competition_id=2" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@path/to/your/submission.csv"

# 7. 查看PPI排行榜
curl "http://localhost:8000/api/leaderboard?competition_id=1"

# 8. 查看CCI排行榜
curl "http://localhost:8000/api/leaderboard?competition_id=2"
```

### 方法2: 使用测试文件

**测试PPI提交**:
```bash
# 使用sample_submission.csv测试
curl -X POST "http://localhost:8000/api/submissions?competition_id=1" \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@kaggle_dataset/sample_submission.csv"
```

**测试CCI提交**:
需要先创建一个测试文件，或使用answer文件的格式创建一个。

---

## 📝 前端集成说明

前端需要做以下修改（已提供API和Store）：

### 1. 在首页添加竞赛选择

```vue
<el-select v-model="competitionStore.selectedCompetitionId" @change="handleCompetitionChange">
  <el-option 
    v-for="comp in competitionStore.competitions"
    :key="comp.id"
    :label="comp.title"
    :value="comp.id"
  />
</el-select>
```

### 2. 提交页面传递竞赛ID

```javascript
import { useCompetitionStore } from '../stores/competition'

const competitionStore = useCompetitionStore()

// 提交时
await submissionAPI.submit(competitionStore.selectedCompetitionId, file)
```

### 3. 排行榜按竞赛筛选

```javascript
// 获取指定竞赛的排行榜
leaderboard.value = await leaderboardAPI.getLeaderboard(competitionId)
```

### 4. 下载对应竞赛的数据集

```javascript
const url = downloadAPI.getDatasetUrl(competitionStore.selectedCompetitionId)
window.open(url, '_blank')
```

---

## 🎨 建议的前端改进

1. **竞赛切换器**
   - 在顶部导航栏添加竞赛选择下拉框
   - 切换竞赛时自动刷新排行榜

2. **竞赛详情页**
   - 显示竞赛描述
   - 显示数据格式
   - 显示评分标准

3. **分竞赛统计**
   - 每个竞赛独立的统计信息
   - 每个竞赛独立的排行榜

---

## ✅ 验证清单

- [x] 数据库包含Competition表
- [x] 初始化时自动创建两个竞赛
- [x] PPI评分脚本正常工作
- [x] CCI评分脚本正常工作
- [x] CCI数据集已打包（dataset.tar.gz）
- [x] API支持竞赛参数
- [x] 排行榜可按竞赛筛选
- [x] 数据下载支持不同竞赛

---

## 🔧 故障排除

### 数据库错误
```bash
# 删除旧数据库重新初始化
rm backend/quiz_platform.db
# 重启后端会自动创建新数据库和竞赛
```

### 竞赛数据未初始化
检查后端启动日志，应该看到：
```
✅ 竞赛数据初始化完成
```

### CCI数据集找不到
```bash
cd "cci test"
tar -czf dataset.tar.gz dataset/
```

---

**系统已就绪！现在你有一个支持多竞赛的完整平台！** 🎉

